<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- favicon -->
  <link rel="icon" href="/favicon.ico" />

  <title>BuhaaTh</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 1rem;
      max-width: 800px;
      margin: auto;
      direction: ltr;
      text-align: left;
    }
    header {
      display: flex;
      justify-content: center;
      align-items: center;
      margin-bottom: 1rem;
    }
    /* نحمل الصورة الأصلية 1024x1024 لكن نقدّر عرضها ليتناسب مع الشاشة */
    header img {
      width: 1024px;
      height: 1024px;
      max-width: 100%;
      height: auto;
    }
    .search-controls {
      margin-bottom: 1rem;
    }
    textarea {
      width: 100%;
      font-size: 1rem;
      padding: .5rem;
      border: 1px solid #ccc;
      border-radius: 4px;
      resize: vertical;
    }
    button {
      display: inline-block;
      margin: 0.5rem 0;
      padding: .5rem 1rem;
      font-size: 1rem;
      background: #0366d6;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    button:disabled {
      background: #999;
      cursor: not-allowed;
    }
    button:hover:not(:disabled) {
      background: #0356b6;
    }
    .year-filter {
      display: flex;
      gap: .5rem;
      flex-wrap: wrap;
      margin-top: .5rem;
    }
    .year-filter label {
      font-size: 0.9rem;
      display: flex;
      align-items: center;
    }
    .year-filter input[type="number"] {
      width: 80px;
      font-size: 1rem;
      padding: .3rem;
      border: 1px solid #ccc;
      border-radius: 4px;
      margin-left: .3rem;
    }
    #results {
      list-style: none;
      padding: 0;
    }
    #results li {
      margin-bottom: 1.5rem;
      border-bottom: 1px solid #eee;
      padding-bottom: .5rem;
    }
    #results a {
      text-decoration: none;
      color: #0366d6;
    }
    #results a:hover {
      text-decoration: underline;
    }
    #results small {
      color: #555;
    }
    #pagination {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 1rem;
      margin-top: 1rem;
    }
    #pagination button {
      padding: .4rem .8rem;
    }
    #pagination span {
      font-size: 1rem;
    }
    @media (max-width: 600px) {
      body { padding: 0.5rem; }
      header img {
        width: 300px; /* أو القيمة المناسبة للجوال */
        height: auto;
      }
      button, #pagination button { width: 100%; }
      .year-filter {
        flex-direction: column;
      }
      .year-filter input[type="number"] {
        width: 100%;
        margin-left: 0;
      }
    }
  </style>
</head>
<body>
  <!-- شعار 1024×1024 -->
  <header>
    <a href="/">
      <!-- width و height لتحميل الصورة الأصلية بدقة 1024x1024 -->
      <img src="/logo.png" alt="" width="1024" height="1024" />
    </a>
  </header>

  <div class="search-controls">
    <textarea id="query" rows="2" placeholder="Ask the research"></textarea><br>
    <button id="searchBtn" onclick="startSearch()">Search</button>
    <div class="year-filter">
      <label>Year from:
        <input type="number" id="yearFrom" placeholder="e.g. 2018" min="1800" max="2099">
      </label>
      <label>Year to:
        <input type="number" id="yearTo" placeholder="e.g. 2023" min="1800" max="2099">
      </label>
    </div>
  </div>

  <ul id="results"></ul>

  <div id="pagination" style="display:none;">
    <button id="prevBtn" onclick="prevPage()">Previous</button>
    <span id="pageInfo"></span>
    <button id="nextBtn" onclick="nextPage()">Next</button>
  </div>

  <script>
    let currentPage = 1;
    const limit = 20;

    function startSearch() {
      currentPage = 1;
      performSearch();
    }

    async function performSearch() {
      const qRaw = document.getElementById("query").value.trim();
      if (!qRaw) {
        alert("Please enter a search query.");
        return;
      }
      const yearFrom = parseInt(document.getElementById("yearFrom").value);
      const yearTo = parseInt(document.getElementById("yearTo").value);

      const query = encodeURIComponent(qRaw);
      const url = `/api/ss-search?q=${query}&limit=${limit}&page=${currentPage}`;
      const resultsEl = document.getElementById("results");
      const paginationEl = document.getElementById("pagination");
      const pageInfoEl = document.getElementById("pageInfo");
      const prevBtn = document.getElementById("prevBtn");
      const nextBtn = document.getElementById("nextBtn");

      document.getElementById("searchBtn").disabled = true;
      prevBtn.disabled = true;
      nextBtn.disabled = true;
      resultsEl.innerHTML = "<li>Searching...</li>";
      paginationEl.style.display = "none";

      try {
        const res = await fetch(url);
        if (!res.ok) throw new Error("Server error");
        const json = await res.json();
        let data = json.data || [];

        if (!isNaN(yearFrom)) {
          data = data.filter(p => p.year && p.year >= yearFrom);
        }
        if (!isNaN(yearTo)) {
          data = data.filter(p => p.year && p.year <= yearTo);
        }

        if (data.length === 0) {
          resultsEl.innerHTML = "<li>No results found.</li>";
        } else {
          resultsEl.innerHTML = data.map(paper => {
            const authors = (paper.authors || []).map(a => a.name).join(", ");
            return `
              <li>
                <a href="${paper.url}" target="_blank">
                  <strong>${paper.title}</strong>
                </a><br>
                <small>${authors} — ${paper.year || 'Unknown'}</small>
              </li>`;
          }).join("");
        }

        const originalCount = (json.data || []).length;
        prevBtn.disabled = currentPage <= 1;
        nextBtn.disabled = originalCount < limit;
        pageInfoEl.textContent = `Page ${currentPage}`;
        paginationEl.style.display = "flex";
      } catch (err) {
        resultsEl.innerHTML = `<li>Error: ${err.message}</li>`;
      } finally {
        document.getElementById("searchBtn").disabled = false;
      }
    }

    function prevPage() {
      if (currentPage > 1) {
        currentPage--;
        performSearch();
      }
    }
    function nextPage() {
      currentPage++;
      performSearch();
    }
  </script>
</body>
</html>
