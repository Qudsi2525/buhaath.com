<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- favicon -->
  <link rel="icon" href="/favicon.ico" />

  <title>Search</title>
  <style>
    /* الضبط العام للصفحة */
    body {
      font-family: sans-serif;
      padding: 1rem;
      max-width: min(720px, 90%);
      margin: auto;
      direction: ltr;
      text-align: left;
      box-sizing: border-box;
    }

    /* Header للشعار */
    header {
      display: flex;
      justify-content: center;
      align-items: center;
      margin-bottom: 1rem;
    }
    header img {
      max-width: 100%;
      height: auto;
    }

    /* عناصر التحكم بالبحث */
    .search-controls {
      margin-bottom: 1rem;
    }
    textarea {
      width: 100%;
      font-size: 1rem;
      padding: 1.5rem 1.8rem; /* الهوامش الداخلية كما طلبت */
      border: 1px solid #f0f0f0;
      border-radius: 18px;
      resize: vertical;
      line-height: 1.6rem;
      box-sizing: border-box;
      margin-bottom: 1.2rem; /* هامش بين عناصر */
    }
    button {
      display: inline-block;
      margin: 0.5rem 0;
      padding: .5rem 1rem;
      font-size: 1rem;
      background: #0366d6;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    button:disabled {
      background: #999;
      cursor: not-allowed;
    }
    button:hover:not(:disabled) {
      background: #0356b6;
    }
    .year-filter {
      display: flex;
      gap: .5rem;
      flex-wrap: wrap;
      margin-top: .5rem;
      margin-bottom: 1.2rem;
    }
    .year-filter label {
      font-size: 0.9rem;
      display: flex;
      align-items: center;
    }
    .year-filter input[type="number"] {
      width: 80px;
      font-size: 1rem;
      padding: .3rem;
      border: 1px solid #f0f0f0;
      border-radius: 4px;
      margin-left: .3rem;
      box-sizing: border-box;
    }

    /* حاوية الرسائل (النتائج) */
    .chat-container {
      width: 100%;
      box-sizing: border-box;
    }
    /* كل رسالة */
    .message {
      display: flex;
      margin-bottom: 1.2rem; /* هامش بين الرسائل */
    }
    /* محاذاة فقاعات المساعد إلى اليسار */
    .message.assistant {
      justify-content: flex-start;
    }
    /* يمكنك إضافة message.user لمحاذاة لليمين إذا أردت */
    /* .message.user { justify-content: flex-end; } */

    /* فقاعات النتائج */
    .bubble {
      max-width: 100%;
      background-color: #ffffff; /* خلفية المساعد */
      color: #333333; /* لون النص */
      border: 1px solid #f0f0f0; /* حد خفيف */
      border-radius: 18px; /* زوايا دائرية */
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08); /* ظل خفيف */
      line-height: 1.6rem; /* ارتفاع السطر */
      padding: 1.5rem 1.8rem; /* هوامش داخلية */
      box-sizing: border-box;
    }
    /* روابط داخل الفقاعة */
    .bubble a {
      color: #0366d6;
      text-decoration: none;
    }
    .bubble a:hover {
      text-decoration: underline;
    }

    /* pagination */
    #pagination {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 1rem;
      margin-top: 1rem;
      margin-bottom: 1rem;
    }
    #pagination button {
      padding: .4rem .8rem;
    }
    #pagination span {
      font-size: 1rem;
    }

    /* Responsive adjustments */
    @media (max-width: 600px) {
      body { padding: 0.5rem; }
      textarea {
        padding: 1rem 1.2rem;
        line-height: 1.5rem;
      }
      .year-filter {
        flex-direction: column;
      }
      .year-filter input[type="number"] {
        width: 100%;
        margin-left: 0;
      }
      button, #pagination button {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <!-- شعار only -->
  <header>
    <a href="/">
      <img src="/logo.png" alt="" width="1024" height="1024" />
    </a>
  </header>

  <!-- عناصر البحث -->
  <div class="search-controls">
    <textarea id="query" rows="2" placeholder="Ask the research"></textarea><br>
    <button id="searchBtn" onclick="startSearch()">Search</button>
    <div class="year-filter">
      <label>Year from:
        <input type="number" id="yearFrom" placeholder="e.g. 2018" min="1800" max="2099">
      </label>
      <label>Year to:
        <input type="number" id="yearTo" placeholder="e.g. 2023" min="1800" max="2099">
      </label>
    </div>
  </div>

  <!-- حاوية النتائج -->
  <div class="chat-container" id="results-container">
    <!-- الرسائل ستُضاف برمجياً هنا -->
  </div>

  <!-- pagination -->
  <div id="pagination" style="display:none;">
    <button id="prevBtn" onclick="prevPage()">Previous</button>
    <span id="pageInfo"></span>
    <button id="nextBtn" onclick="nextPage()">Next</button>
  </div>

  <script>
    let currentPage = 1;
    const limit = 20;

    function startSearch() {
      currentPage = 1;
      performSearch();
    }

    async function performSearch() {
      const qRaw = document.getElementById("query").value.trim();
      if (!qRaw) {
        alert("Please enter a search query.");
        return;
      }
      const yearFrom = parseInt(document.getElementById("yearFrom").value);
      const yearTo = parseInt(document.getElementById("yearTo").value);

      const query = encodeURIComponent(qRaw);
      const url = `/api/ss-search?q=${query}&limit=${limit}&page=${currentPage}`;
      const container = document.getElementById("results-container");
      const paginationEl = document.getElementById("pagination");
      const pageInfoEl = document.getElementById("pageInfo");
      const prevBtn = document.getElementById("prevBtn");
      const nextBtn = document.getElementById("nextBtn");

      // تعطيل أثناء التحميل
      document.getElementById("searchBtn").disabled = true;
      prevBtn.disabled = true;
      nextBtn.disabled = true;
      // نظف الحاوية وأضف رسالة انتظار
      container.innerHTML = '';
      const loadingMsg = document.createElement('div');
      loadingMsg.className = 'message assistant';
      loadingMsg.innerHTML = '<div class="bubble">Searching...</div>';
      container.appendChild(loadingMsg);
      paginationEl.style.display = "none";

      try {
        const res = await fetch(url);
        if (!res.ok) throw new Error("Server error");
        const json = await res.json();
        let data = json.data || [];

        // فلترة بالسنة client-side
        if (!isNaN(yearFrom)) {
          data = data.filter(p => p.year && p.year >= yearFrom);
        }
        if (!isNaN(yearTo)) {
          data = data.filter(p => p.year && p.year <= yearTo);
        }

        // عرض النتائج في فقاعات
        container.innerHTML = ''; // نظف رسالة الانتظار
        if (data.length === 0) {
          const msg = document.createElement('div');
          msg.className = 'message assistant first';
          msg.innerHTML = '<div class="bubble">No results found.</div>';
          container.appendChild(msg);
        } else {
          data.forEach((paper, idx) => {
            const msgDiv = document.createElement('div');
            msgDiv.className = 'message assistant' + (idx === 0 && currentPage === 1 ? ' first' : '');
            const authors = (paper.authors || []).map(a => a.name).join(", ");
            const titleEsc = paper.title.replace(/</g, "&lt;").replace(/>/g, "&gt;");
            const authorsEsc = authors.replace(/</g, "&lt;").replace(/>/g, "&gt;");
            const yearText = paper.year || 'Unknown';
            msgDiv.innerHTML = `
              <div class="bubble">
                <a href="${paper.url}" target="_blank"><strong>${titleEsc}</strong></a><br>
                <small>${authorsEsc} — ${yearText}</small>
              </div>`;
            container.appendChild(msgDiv);
          });
        }

        // إعداد pagination
        const originalCount = (json.data || []).length;
        prevBtn.disabled = currentPage <= 1;
        nextBtn.disabled = originalCount < limit;
        pageInfoEl.textContent = `Page ${currentPage}`;
        paginationEl.style.display = "flex";
      } catch (err) {
        container.innerHTML = '';
        const errMsg = document.createElement('div');
        errMsg.className = 'message assistant first';
        errMsg.innerHTML = `<div class="bubble">Error: ${err.message}</div>`;
        container.appendChild(errMsg);
      } finally {
        document.getElementById("searchBtn").disabled = false;
      }
    }

    function prevPage() {
      if (currentPage > 1) {
        currentPage--;
        performSearch();
      }
    }
    function nextPage() {
      currentPage++;
      performSearch();
    }
  </script>
</body>
</html>
